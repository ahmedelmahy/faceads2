<!doctype html>
<!--[if IE 9]> <html class="no-js ie9 fixed-layout" lang="en"> <![endif]-->
<!--[if gt IE 9]><!--> <html class="no-js " lang="en"> <!--<![endif]-->
<head>

    <!-- Basic -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
     
    <!-- Mobile Meta -->
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- Site Meta -->
    <title>WAKEB</title>
    <meta name="keywords" content="AI">
    <meta name="description" content="AI Wakeb">
    <meta name="author" content="Wakeb">
    
    <!-- Site Icons -->
    <link rel="apple-touch-icon" sizes="57x57" href="{{ url_for('static', filename='images/siteicons/apple-icon-57x57.png')}}">
    <link rel="apple-touch-icon" sizes="60x60" href="{{ url_for('static', filename='images/siteicons/apple-icon-60x60.png')}}">
    <link rel="apple-touch-icon" sizes="72x72" href="{{ url_for('static', filename='images/siteicons/apple-icon-72x72.png')}}">
    <link rel="apple-touch-icon" sizes="76x76" href="{{ url_for('static', filename='images/siteicons/apple-icon-76x76.png')}}">
    <link rel="apple-touch-icon" sizes="114x114" href="{{ url_for('static', filename='images/siteicons/apple-icon-114x114.png')}}">
    <link rel="apple-touch-icon" sizes="120x120" href="{{ url_for('static', filename='images/siteicons/apple-icon-120x120.png')}}">
    <link rel="apple-touch-icon" sizes="144x144" href="{{ url_for('static', filename='images/siteicons/apple-icon-144x144.png')}}">
    <link rel="apple-touch-icon" sizes="152x152" href="{{ url_for('static', filename='images/siteicons/apple-icon-152x152.png')}}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='images/siteicons/apple-icon-180x180.png')}}">
    <link rel="icon" type="image/png" sizes="192x192"  href="{{ url_for('static', filename='images/siteicons/android-icon-192x192.png')}}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='images/siteicons/favicon-32x32.png')}}">
    <link rel="icon" type="image/png" sizes="96x96" href="{{ url_for('static', filename='images/siteicons/favicon-96x96.png')}}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='images/siteicons/favicon-16x16.png')}}">
    <link rel="manifest" href="{{ url_for('static', filename='images/siteicons/manifest.json')}}">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="{{ url_for('static', filename='images/siteicons/ms-icon-144x144.png')}}">
    <meta name="theme-color" content="#ffffff">


	
    <!-- Custom & Default Styles -->
	<link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css')}}">
	<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css')}}">
	<!--[if lt IE 9]>
		<script src="{{ url_for('static', filename='js/vendor/html5shiv.min.js')}}"></script>
		<script src="{{ url_for('static', filename='js/vendor/respond.min.js')}}"></script>
	<![endif]-->

</head>
<body>


    <!-- Loading Animation-->
    <div id="layout-loading">
        <div class="loader-effect"></div>
    </div>

 <!-- Modal -->
  <div class="modal fade" id="videoModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">x</span>
          </button>
        </div>
        <div class="modal-body">
            <div class="adv-content">
              <video autoplay muted loop id = "myVideo" src="{{ url_for('static', filename='images/img_waiting.mp4') }}" type="video/mp4">
                        Your browser does not support the video tag.
              </video>
              
            </div>  
            <div class="adv-overflow">
                <div class="chosen">
                    <div class="title">chosen Ad for</div>
                    <ul>
                        <li>
                            <img src="{{ url_for('static', filename='images/brush.png')}}">
                            <span><small id="Age">Loading.. </small> Years old</span>
                        </li>
                        <li>
                            <img src="{{ url_for('static', filename='images/gender.png')}}">
                            <span id="Gender">Loading..</span>
                        </li>
                        <li>
                            <img src="{{ url_for('static', filename='images/smile.png')}}">
                            <span id="Emotion">Loading..</span>
                        </li>
                        <li>
                            <img src="{{ url_for('static', filename='images/glasses.png')}}">
                            <span id="Wearing_Glasses">Loading..</span>
                        </li>
                    </ul>
                </div>
                <div class="statics">
                    <div class="title">Statics</div>
                    <fieldset>
                        <legend>Viewers</legend>
                        <ul>
                            <li>
                                <label>All</label>
                                <span id="All">0</span>
                            </li>
                            <li>
                                <label>Males</label>
                                <span id="Males">0</span>
                            </li>
                            <li>
                                <label>Females</label>
                                <span id="Females">0</span>
                            </li>
                            <li>
                                <label>Glasses</label>
                                <span id="Glasses">0</span>
                            </li>
                        </ul>
                    </fieldset>
                    <fieldset>
                        <legend>Ads</legend>
                        <ul>
                            <li>
                                <label>Males Ads</label>
                                <span id="Males_Ads">0</span>
                            </li>
                            <li>
                                <label>Females Ads</label>
                                <span id="Females_Ads">0</span>
                            </li>
                            <li>
                                <label>Glasses Ads</label>
                                <span id="Glasses_Ads">0</span>
                            </li>
                        </ul>
                    </fieldset>
                    <fieldset>
                        <legend>Time</legend>
                        <ul>
                            <li>
                                <label>Current Viewer</label>
                                <span id="Current_Viewer">0</span>
                            </li>
                            <li>
                                <label>Total times</label>
                                <span id="Total_times">0</span>
                            </li>
                        </ul>
                    </fieldset>
                    <fieldset>
                        <legend>Be happy for <small id="emotion_to_zero">100</small> seconds</legend>
                        <ul>
                            <li>
                                <label id="Happy">Happy</label>
                                <div class="progress">
                                  <div class="progress-bar" id="progressHappy" role="progressbar" aria-valuenow="0"
                                  aria-valuemin="0" aria-valuemax="100" style="width:0%">
                                  </div>
                                </div>
                            </li>
                            <li>
                                <label id="Normal">Normal</label>
                                <div class="progress">
                                  <div class="progress-bar" id="progressNormal" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                </div>
                            </li>
                        </ul>
                    </fieldset>
                </div>
            </div>
        </div>
      </div>
    </div>
  </div>
  <div id="wrap">

    <!-- Header -->
    <div id="header">   
        <div class="navigation fixed-top background scroll">
                <div class="container">
                    <nav id="navbar-example" class="navbar navbar-expand-lg navbar-light">
                        <a class="navbar-brand brand-logo" target="-blank" href="http://wakeb.tech/">
                            <img src="{{ url_for('static', filename='images/logo.png')}}" alt="Wakeb" title="Wakeb">
                        </a>
                                                
                        <button class="navbar-toggler hamburger " style=" visibility: visible;" type="button" data-toggle="collapse" data-target="#nav-content" aria-controls="nav-content" aria-expanded="false" aria-label="Toggle navigation">
                            <span class="hamburger-box">
                            <span class="hamburger-label"></span>
                            <span class="hamburger-inner"></span>
                          </span>
                          </button>                    

                        <div class="top-nav collapse navbar-collapse" id="nav-content">   
                            <ul class="navbar-nav ml-auto">
                                <li class="nav-item">
                                    <a href="#">Home</a>
                                </li>
                                <li class="nav-item">
                                    <a href="#">Products</a>
                                </li>
                                <li class="nav-item">
                                    <a href="#">Services</a>
                                </li>
                                <li class="nav-item">
                                    <a href="#">Solutions</a>
                                </li>
                                <li class="nav-item">
                                    <a href="#">Blog</a>
                                </li>
                                <li class="nav-item">
                                    <a href="#">About us</a>
                                </li>
                                <li class="nav-item">
                                    <a href="#">Contact us</a>
                                </li>
                                <li class="nav-item d-flex align-items-center">
                                    <a href="index.rtl.html">
                                        <img src="{{ url_for('static', filename='images/lang.png')}}" class="mr-1">
                                        <span>Arabic</span>
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </nav>
            </div>
        </div>
    </div>
    <!--/. Header -->

    <!-- Page intro -->
    <div id="hero-bg" class="scroll top">
        <div class="container">
            <div class="hero-inner row">
                <div class="col-lg-6 col-md-7">
                    <div class="hero-content">
                        <div class="powered-by">
                            <div class="media">
                              <img src="{{ url_for('static', filename='images/robot.png')}}" class="mr-2">
                              <div class="media-body">
                                <h5 class="my-0">Product powered by</h5>
                                <h3 class="my-0">MASBAR</h3>
                              </div>
                            </div>
                        </div>
                        <h1>Intelligent Personalized Marketing System (IPMS)</h1>
                        <p>Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam era.</p>
                        <ul>
                            <li>Step1</li>
                            <li >
                                <button class="btn link" id="snap">
                                    <span>Open Camera</span> 
                                    <img src="{{ url_for('static', filename='images/cam.png')}}"></button>
                            </li>
                            <li class="check"><img src="{{ url_for('static', filename='images/check.png')}}"></li>
                        </ul>
                        <ul>
                            <li>Step2</li>
                            <li >
                                <button class="btn  link" id="play" data-toggle="modal" data-target="#videoModal">
                                    <span>View Ad</span> 
                                    <img src="{{ url_for('static', filename='images/play.png')}}"></button>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="col-lg-6 col-md-5 hide-small">
                    <div class="here-side-img">
                        <img src="{{ url_for('static', filename='images/face-IPMS.svg')}}">
			            <div id="videocontainer" class="divcontainer text-center"  style="display: none;">
                            	<video onplay="onPlay(this)" id="inputVideo" autoplay muted type="video/mp4"></video>
                            <canvas id="overlay" />
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
    <!-- /. Page intro -->

    <!--Footer-->
    <div class="dark-footer">
        <div class="container">
        <div class="row">
            <div class="logo col-md-4 ">
                <a target="_blank" href="http://wakeb.tech/"><img src="{{ url_for('static', filename='images/light-wakeb.png')}}" alt="wakeb" title="wakeb"></a>
            </div>
            <div class="col-md-8 cpr">
                Product powered by Wakeb, All copyrights reserved © 2019
            </div>
        </div>
        </div>
    </div>
    <!-- /. Footer -->    

  </div><!--./wrap -->






























  <script src="{{ url_for('static', filename='js/bootstrap.min.js')}}"></script>
  <script src="{{ url_for('static', filename='js/face-api.min.js')}}"></script>
  <script src="https://code.jquery.com/jquery-1.12.2.min.js" type="text/javascript"></script>

  <script>
        faceapi.loadTinyFaceDetectorModel('https://www.rocksetta.com/tensorflowjs/saved-models/face-api-js/')

        faceapi.nets.ageGenderNet.loadFromUri("{{ url_for('static', filename='/models')}}")
        faceapi.nets.ssdMobilenetv1.loadFromUri("{{ url_for('static', filename='/models')}}")

        faceapi.nets.faceExpressionNet.loadFromUri("{{ url_for('static', filename='/models')}}")
</script>
<script>
// start of javascript ...................................
// ...............................................................
// ...............................................................
// ...............................................................
// ...............................................................
// ...............................................................
// ...............................................................
// ...............................................................
      $(document).ready(function() {
          faceapi.tf.ENV.set('WEBGL_PACK', false)

      })
      const videoEl = document.getElementById('inputVideo')
      const canvas = document.getElementById('overlay')
      var video1 = document.getElementById("myVideo");


      async function run() {
			faceapi.nets.tinyFaceDetector.loadFromUri("{{ url_for('static', filename='/models')}}")
            faceapi.nets.ageGenderNet.loadFromUri("{{ url_for('static', filename='/models')}}")
            faceapi.nets.ssdMobilenetv1.loadFromUri("{{ url_for('static', filename='/models')}}")
    
            faceapi.nets.faceExpressionNet.loadFromUri("{{ url_for('static', filename='/models')}}")
          const stream = await navigator.mediaDevices.getUserMedia({ video: true })
          videoEl.srcObject = stream;

      }
      function resizeCanvasAndResults(dimensions, canvas, results) {
          const { width, height } = dimensions instanceof HTMLVideoElement
              ? faceapi.getMediaDimensions(dimensions)
              : dimensions
          //return results.map(res => res)
          return results
      };

      function drawDetections(dimensions, canvas, results) {

      };
      function median(values){
        if(values.length ===0) return 0;

        values.sort(function(a,b){
            return a-b;
        });

        var half = Math.floor(values.length / 2);

        if (values.length % 2)
            return values[half];

        return (values[half - 1] + values[half]) / 2.0;
      }
      
      async function onPlay(videoEl) {

          const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 416, scoreThreshold: 0.2 })
          var result = await faceapi.detectSingleFace(videoEl, options).withFaceExpressions().withAgeAndGender()

          if (result) {
              console.log(result.age)
              if (ageCorrector === 1 ){
                average_age = [result.age]
                ageCorrector = 0
              } else {
                average_age.push(result.age)
                
              }
              var age1 = Math.round(median(average_age))
              gender1 = result.gender
              var ex = result.expressions
              var ex1 = Object.keys(ex).reduce((a, b) => ex[a] > ex[b] ? a : b);
              const resizedResults = resizeCanvasAndResults(videoEl, canvas, result.detection)

              cropped_box = resizedResults.box

              dim_x = Math.round(cropped_box.x)
              dim_y = Math.round(cropped_box.y)
              dim_width = Math.round(cropped_box.width)
              dim_height = Math.round(cropped_box.height)
              var crop = {
                  top :  Math.max((dim_y - 55),0),
                  left : dim_x ,
                  width : dim_width + 20,
                  height : dim_height + 50
              }
              var ctx = canvas.getContext("2d");

              canvas.width = 128
              canvas.height = 128
              ctx.drawImage(videoEl, crop.left, crop.top, crop.width, crop.height, 0, 0, 128, 128);
              send_canvas_ctx(age1, gender1,ex1);

              if (reversecounter > 1 && glassesvariable != ''){

                counter = counter + 1
                document.getElementById('All').innerHTML = counter;
                console.log("a new person passed by ")

                if (gender1 === "male" && glassesvariable === 'glasses'){

                    countermanglasses = countermanglasses + 1
                    document.getElementById('Males').innerHTML = countermanglasses + countermannoglasses;
                    document.getElementById('Glasses').innerHTML = countermanglasses + counterwomanglasses;
                } else if (gender1 === "female" && glassesvariable === 'glasses') {

                    counterwomanglasses = counterwomanglasses + 1
                    document.getElementById('Females').innerHTML = counterwomanglasses + countermanglasses;
                    document.getElementById('Glasses').innerHTML = countermanglasses + counterwomanglasses;
                } else if (gender1 === "male" && glassesvariable === 'noglasses') {

                    countermannoglasses = countermannoglasses + 1
                    document.getElementById('Males').innerHTML = countermanglasses + countermannoglasses;
                } else if (gender1 === "female" && glassesvariable === 'noglasses') {

                    counterwomannoglasses = counterwomannoglasses + 1
                    document.getElementById('Females').innerHTML = counterwomanglasses + counterwomannoglasses;
                }

                



              }
              time_in_front_of_camera = time_in_front_of_camera + 2
              document.getElementById('Current_Viewer').innerHTML = time_in_front_of_camera  ;
              document.getElementById('Total_times').innerHTML =  total_time + time_in_front_of_camera ;


              if (glassesvariable != ''){
                reversecounter = 0
              }
              reverse_time_in_front_of_camera = 0
              

          }
          else {
              ageCorrector = 1
              emotion_to_zero = 0
              document.getElementById('emotion_to_zero').innerHTML = emotion_to_zero;
              document.getElementById("progressNormal").style.width =  "0%"
              document.getElementById("progressHappy").style.width = "0%"


              current_video = "" 
              if (video1.getAttribute("src") !== "{{ url_for('static', filename='images/img_waiting.mp4') }}"){
                  video1.setAttribute("src", "{{ url_for('static', filename='images/img_waiting.mp4') }}")
               }
              reversecounter = reversecounter + 1

              reverse_time_in_front_of_camera = reverse_time_in_front_of_camera + 1
              if (reverse_time_in_front_of_camera > 1 && time_in_front_of_camera > 0){
                    console.log("time spent by last person was: ")
                    console.log(time_in_front_of_camera)
                    total_time = total_time + time_in_front_of_camera
                    time_in_front_of_camera = 0
                    reverse_time_in_front_of_camera = 0
                    document.getElementById('Current_Viewer').innerHTML = 0  ;
                    document.getElementById('Total_times').innerHTML =  total_time ;
                    

                }
                
                }
            console.log(ageCorrector)
            console.log(age1)
            console.log(average_age)
      }

      document.getElementById("snap").addEventListener("click", function() {
          run()
      });
      var counter = 0
      var happyCounter = 0
      var normalCounter = 0
      var sadCounter = 0
      var countermanglasses = 0
      var countermannoglasses = 0
      var counterwomanglasses = 0
      var counterwomannoglasses = 0
      var reversecounter = 20000
      var time_in_front_of_camera = 0
      var total_time = 0
      var reverse_time_in_front_of_camera = 0
      var gender1 = ''
      var glassesvariable = ''
      var sadzone = 0
      var emotion_to_zero = 10
      var Males_Ads = 0
      var Females_Ads = 0
      var Glasses_Ads = 0
      var average_age = [0]
      var ageCorrector = 1
      document.getElementById("play").addEventListener("click", function() {
        window.setInterval(function(){onPlay(videoEl)}, 2000);
      });
      var current_video = ""

      function send_canvas_ctx(age1,gender1,ex1) {
          emotion_to_zero = emotion_to_zero - 2
          document.getElementById('emotion_to_zero').innerHTML = emotion_to_zero;

          if (emotion_to_zero < 4){
            emotion_to_zero = 10
            happyCounter = 0
            normalCounter = 0 
          }

          document.getElementById('Age').innerHTML = age1;
          if (gender1 === "male"){
            document.getElementById('Gender').innerHTML = "Man";
          } else if (gender1 === "female") {
          document.getElementById('Gender').innerHTML = "Woman";
          }

          if (ex1 === "neutral"){
            document.getElementById('Emotion').innerHTML = "Normal";

            document.getElementById("Happy").style.color="black";
            document.getElementById("Normal").style.color="green";

            normalCounter = normalCounter + 1
            var percentageNormal = Math.round((normalCounter / (normalCounter + happyCounter ) ) * 100)
            var percentageHappy = Math.round((happyCounter / (normalCounter + happyCounter )) * 100)

            document.getElementById("progressNormal").style.width = percentageNormal.toString() + "%"
            document.getElementById("progressHappy").style.width = percentageHappy.toString() + "%"


          } else if (ex1 === "happy") {
            document.getElementById('Emotion').innerHTML = "Happy";

            document.getElementById("Happy").style.color="green";
            document.getElementById("Normal").style.color="black";

            happyCounter = happyCounter + 1
            var percentageNormal = Math.round((normalCounter / (normalCounter + happyCounter ) ) * 100)
            var percentageHappy = Math.round((happyCounter / (normalCounter + happyCounter )) * 100)
            document.getElementById("progressNormal").style.width = percentageNormal.toString() + "%"
            document.getElementById("progressHappy").style.width = percentageHappy.toString() + "%"

          } else if (ex1 === "sad") {
            document.getElementById('Emotion').innerHTML = "Sad";

            document.getElementById("Happy").style.color="black";
            document.getElementById("Normal").style.color="black";
          }else if (ex1 === "angry") {
            document.getElementById("Happy").style.color="black";
            document.getElementById("Normal").style.color="black";
          }else if (ex1 === "fearful") {
            document.getElementById("Happy").style.color="black";
            document.getElementById("Normal").style.color="black";
          }else if (ex1 === "disgusted") {
            document.getElementById("Happy").style.color="black";
            document.getElementById("Normal").style.color="black";
          }else if (ex1 === "surprised") {
            document.getElementById("Happy").style.color="black";
            document.getElementById("Normal").style.color="black";
          }

 
          input_data = canvas.toDataURL('image/png');
          window.fetch('/snap_a_signal', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                  data: input_data,
                  selected_model: "glass"
              })
          }).then((response) => response.json()).then((json) =>  {
              message_to_show = json["results"] + '\n' + json["accuracy"]
              glassesvariable = json["results"] 
              if (video1.getAttribute("src") === "{{ url_for('static', filename='images/m.mp4') }}"){
                  current_video = "man"
              } else if (video1.getAttribute("src") === "{{ url_for('static', filename='images/w.mp4') }}") {
                  current_video = "woman"
              } else if (video1.getAttribute("src") === "{{ url_for('static', filename='images/g.mp4') }}") {
                  current_video = "glasses"
              } 
              //else if (video1.getAttribute("src") === "{{ url_for('static', filename='images/sad.mp4') }}") {
               //   current_video = "sad"
              //}
                // if (ex1 === "sad" || sadzone > 0){
                   // if (current_video != "sad"){
                   //     sadzone = 7
                  //      video1.setAttribute("src", "{{ url_for('static', filename='images/sad.mp4')}}")
                 //   } 
                //} else 
                if (json["results"] === "glasses"){
                    if (current_video != "glasses"){
                        document.getElementById('Wearing_Glasses').innerHTML = "Wearing glasses";
                        video1.setAttribute("src", "{{ url_for('static', filename='images/g.mp4')}}")
                        Glasses_Ads = Glasses_Ads + 1
                        document.getElementById('Glasses_Ads').innerHTML = Glasses_Ads;
                    }
                } else if (json["results"] === "noglasses"){
                    document.getElementById('Wearing_Glasses').innerHTML = "No glasses";
                    if (gender1 === "male"){
                        if (current_video != "man"){
                            Males_Ads = Males_Ads + 1
                            document.getElementById('Males_Ads').innerHTML = Males_Ads;
                            video1.setAttribute("src", "{{ url_for('static', filename='images/m.mp4')}}")
                        }
                    } else if (gender1 === "female"){
                        if (current_video != "woman"){
                            video1.setAttribute("src", "{{ url_for('static', filename='images/f.mp4')}}")

                            Females_Ads = Females_Ads + 1
                            document.getElementById('Females_Ads').innerHTML = Females_Ads;
                        }
                    }
                  }
              
                //if (sadzone > 0){
                //    sadzone = sadzone - 1
                //}

          });
        }

  </script>
  <script src="{{ url_for('static', filename='js/functions.js')}}"></script>

  <script src="{{ url_for('static', filename='js/jquery.min.js')}}"></script>		
  <script src="{{ url_for('static', filename='js/bootstrap.min.js')}}"></script>		
  <script src="{{ url_for('static', filename='js/animate.js')}}"></script>		
  <script src="{{ url_for('static', filename='js/custom.js')}}"></script>
</body>
</html>
